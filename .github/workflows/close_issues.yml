name: Close Issues

on:
  push:
    paths:
      - '-data/int/closes.txt'

permissions:
  issues: write
  contents: write

jobs:
  close-issues:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Read issues list
        id: read-list
        run: |
          if [ ! -f ./-data/int/closes.txt ]; then
            echo "No closes.txt file found."
            exit 0
          fi
          issues=$(cat ./-data/int/closes.txt | grep '^#' | sed 's/^#//g' | tr '\n' ' ')
          echo "issues=$issues" >> $GITHUB_OUTPUT

      - name: Close issues
        if: steps.read-list.outputs.issues != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issues = '${{ steps.read-list.outputs.issues }}'.trim().split(' ');
            let now = new Date();
            let nextStart = new Date(now);
            nextStart.setUTCHours(7, 2, 0, 0);
            if (nextStart < now) {
              nextStart.setUTCDate(nextStart.getUTCDate() + 1);
            }
            let nextFinish = new Date(nextStart);
            nextFinish.setUTCHours(nextFinish.getUTCHours() + 1);
            const diffMs = nextFinish - now;
            const etaHours = Math.ceil(diffMs / (1000 * 60 * 60));
            const finishTime = nextFinish.toUTCString();
            const message = `Thank you for reporting this.\n\nWe've addressed it, with the fix scheduled for our next release (in approx. ${etaHours} hours).\nIf problems persist or you have more details, feel free to reopen or reply.`;
            for (const issue_number of issues) {
              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  body: message
                });
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue_number,
                  state: 'closed'
                });
                console.log(`Closed issue #${issue_number}`);
              } catch (error) {
                console.error(`Failed to close issue #${issue_number}: ${error.message}`);
              }
            }

      - name: Reset closes.txt
        run: |
          echo "" > ./-data/int/closes.txt

      - name: Commit and push reset
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add ./-data/int/closes.txt
          git commit -m "Reset closes.txt" || echo "No changes to commit"
          git push
          
